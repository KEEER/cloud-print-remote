{% extends 'framework.html' %}

{% block title %} 上传文件 | Cloud Print {% endblock title%}

{% block stylesheet%}
<link rel="stylesheet" href="/static/css/index.css" />
{% endblock stylesheet %}

{% block content %}
  <div class="mdc-card printer-card">
    <img class="printer-card__logo" src="https://squoosh.app/logo.af355.svg" />
    <div class="printer-card__content">
      <h5 class="mdc-typography--headline5" style="margin: 0 10px 0 0;"id="printer-info">ICC楼四层东侧</h5>
      <div class="printer-card__status">
        <span clas="mdc-typography--body1">状态： </span>
        <span class="printer-status printer-status__unavaliable" id="printer-status-icon">⬤</span>
        <span clas="mdc-typography--body1" id="printer-status">不可用</span>
      </div>
      <span clas="mdc-typography--body1" id="printer-description">描述：这是一台打印机</span>
    </div>
  </div>
  <div class="file-list-container" id="job-list">
  </div>
  <div class="file-drop-zone" id="file-zone">
    <span class="mdc-typography--headline5 drag-info" id="upload-info">☺️ 拖拽您要打印的文件到这里</span>
    <p class="drag-info">或者</p>
    <div>
      <button onclick="javascript: document.getElementById('file').click();" class="mdc-button mdc-button--raised">选择一个文件</button>
    </div>
  </div>
  <div class="mdc-dialog"
     role="alertdialog"
     aria-modal="false"
     aria-labelledby="my-dialog-title"
     aria-describedby="my-dialog-content">
    <div class="mdc-dialog__container">
      <div class="mdc-dialog__surface">
        <!-- Title cannot contain leading whitespace due to mdc-typography-baseline-top() -->
        <h2 class="mdc-dialog__title" id="my-dialog-title"><!--
      -->您的打印码<!--
    --></h2>
        <div class="mdc-dialog__content"> 
          <h3 class="mdc-typography--headline3"id="print-code"></h3>
          <span class="mdc-typography--body1">走到打印机前，输入上方的四个数字 即可立刻打印您的文件</span>
          <p></p>
          <span class="mdc-typography--body1">您未打印的文件将被保存24小时</span>
        </div>
        <footer class="mdc-dialog__actions">
          <button type="button" class="mdc-button mdc-dialog__button" data-mdc-dialog-action="close">
            <span class="mdc-button__label">关闭</span>
          </button>
        </footer>
      </div>
    </div>
    <div class="mdc-dialog__scrim"></div>
  </div>
<input id="file" type="file" accept="application/pdf" style="display: none;" />
{% endblock content %}
{% block script %}
<script src="https://cdn.jsdelivr.net/npm/@material/dialog@2.3.0/dist/mdc.dialog.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@material/switch@2.3.0/dist/mdc.switch.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@material/auto-init@2.3.0/dist/mdc.autoInit.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@material/textfield@2.3.0/dist/mdc.textfield.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@material/dialog@2.3.0/dist/mdc.dialog.min.js"></script>
<script id="jobTemplate" language="x/template">
  <div class="mdc-card job-card" id="job-::id::">
    <div class="job-card--content">
    <span class="mdc-typography--headline5 job-title">::jobTitle::</span>
    <span class="mdc-typography--body">共 <span id="page-number">::pageNumber::</span> 页；
                                          <span id="price">::price::</span> 元
    </span>
    </div>
    <div class="job-card--options">
      <div class="switch">
        <div class="mdc-switch" id="ds-switch" data-mdc-auto-init="MDCSwitch">
          <div class="mdc-switch__track"></div>
          <div class="mdc-switch__thumb-underlay">
            <div class="mdc-switch__thumb">
              <input type="checkbox" id="double-sided-switch" class="mdc-switch__native-control" role="switch" />
            </div>
          </div>
        </div>
        <label for="double-sided-switch">双面打印</label>
      </div>
      <div class="switch">
        <div class="mdc-switch" id="c-switch" data-mdc-auto-init="MDCSwitch">
          <div class="mdc-switch__track"></div>
          <div class="mdc-switch__thumb-underlay">
            <div class="mdc-switch__thumb">
              <input type="checkbox" id="color-swtich" class="mdc-switch__native-control" role="switch" />
            </div>
          </div>
        </div>
        <label for="color-switch">彩色打印</label>
      </div>

      <div class="mdc-text-field mdc-text-field--outlined copies" id="c" data-mdc-auto-init="MDCTextField">
        <input id="copies" type="number" min="1" max="10" step="1" class="mdc-text-field__input" value="1" required />
        <div class="mdc-notched-outline mdc-notched-outline--upgraded">
          <div class="mdc-notched-outline__leading"></div>
          <div class="mdc-notched-outline__notch" style="">
            <label for="copies" class="mdc-floating-label mdc-floating-label--float-above" style="">打印份数</label>
          </div>
          <div class="mdc-notched-outline__trailing"></div>
        </div>
      </div>
    </div>

    <div class="job-card--actions">
      <button id="go-print" class="mdc-button mdc-button--raised">去打印</button>
      <button id="delete-job" class="mdc-button mdc-button--outlined">删除任务</button>
    </div>
    <input type="file" style="display: none;" id="file-body"></input>
  </div>
</script>
<script type="text/javascript">
  var $ = function (value) { return document.querySelector(value) }

  const MAX_JOB_NUMBER = 1;
  var jobTemplate = $('#jobTemplate').innerHTML
  mdc.autoInit.mdcAutoInit.register('MDCTextField', mdc.textfield.MDCTextField)
  mdc.autoInit.mdcAutoInit.register('MDCTextFieldHelperText', mdc.textfield.MDCTextFieldHelperText)
  mdc.autoInit.mdcAutoInit.register('MDCSwitch', mdc.switch.MDCSwitch)
  // [element control]
  class PrinterCard {
    static _setPrinterAvaliability(isAvaliable) {
      $('#printer-status-icon').classList.remove(isAvaliable ? 'printer-status__unavaliable': 'printer-status__avaliable')
      $('#printer-status-icon').classList.add(isAvaliable ? 'printer-status__avaliable': 'printer-status__unavaliable')
      $('#printer-status').innerText = isAvaliable ? '就绪' : '不可用'
    }
    static setPrinterInfo (name, isAvaliable, description) {
      $('#printer-info').innerText = name
      this._setPrinterAvaliability(isAvaliable)
      $('#printer-description').innerText = description
    }
  }
  PrinterCard.setPrinterInfo('A printer', true, 'This is a printer; I like printers; Printers are good for our health.')
  
  var dialogBox = new mdc.dialog.MDCDialog($('.mdc-dialog'))
  function popDialog(jobCode) {
    $('#print-code').innerText = jobCode
    dialogBox.open()
  }
  var hideUploadField = function() {
    console.log('hideJob')
    $('#file-zone').classList.add('invisible')
  }
  var showUploadField = function() {
    console.log('showJob')
    $('#file-zone').classList.remove('invisible')
  }
  var addJob = function (fileName, code, id, config) {
      $('#job-list').innerHTML += jobTemplate
        .replace(/::id::/g, currentStatus.jobNumber)
        .replace(/::jobTitle::/g, fileName)
        .replace(/::pageNumber::/g, config.copies)
        .replace(/::price::/g, 10)
      mdc.autoInit.mdcAutoInit()
      var jobSelector = '#job-' + currentStatus.jobNumber
      // to distinguish between jobs
      var $$ = function(selector) { return $(jobSelector).querySelector(selector)}
      // about info
      var pageNumber = $$('#page-number')
      var price = $$('#price') 
      // about config
      var doubleSidedSwitch =$$('#ds-switch').MDCSwitch
      var colorSwitch = $$('#c-switch').MDCSwitch
      var copiesTextfield = $$('#c').MDCTextField
      // about action
      var printButton = $$('#go-print')
      var deleteJobButton = $$('#delete-job')
        
      printButton.onclick = function() {
        popDialog(code)
      }

      deleteJobButton.onclick = function () {
        popDialog('Delete!')
        // TODO
      }

      doubleSidedSwitch.onchange = colorSwitch.onchange = copiesTextfield.onchange = function() {
        /*
        updateConfig(id, doubleSidedSwitch.checked, colorSwitch.checked, copiesTextfield.value)
          .then(function() {
            // update price
            return 
              
          })
          .then(function(response) {
            console.log(response)
          })
          .catch(function(reason){console.log(reason)})
        */
        if (copiesTextfield.value == null || copiesTextfield.value == '') copiesTextfield.value=1
        console.log('Value changed')
      }
    }
  //end element control
/*
  var currentStatus = {
    "jobNumber": 0,
    "kreditAvaliable": 0,
    "inDebt": false
  }
  var currentPrinter = {
    "id": 255,
    "ip": '0.0.0.0',
    "avaliable": true,
    "name": 'A printer',
    "description": 'This is a printer; I like printers; Printers are good for our health.'
  };
  var updatePrinter = async function() {
    var printerConfigs = await fetch('/_api/printer-ips').then(res => res.json())
    for(var id in Object.keys(printerConfigs)) {
      var ip = printerConfigs[id]
      var printerConfig = await fetch(ip+'/status', {method: 'GET'}, 3000)
      if(printerConfig.ok) {
        var config = await printerConfig.json()
        currentPrinter = {
          "id": id,
          "ip": ip,
          "avaliable": true,
          "name": config.name,
          "description": config.message
        }
        break
      }
    }

    if (!currentPrinter) {
      // TODO:
      console.log("No printers Avaliable")
    }
  }
  //updatePrinter()

  var updatePrinterInfo = async function() {
    try {
      var newConfig = await(currentPrinter.ip+'/status').then(res => res.json())
      currentPrinter.description = newConfig.message
    } catch(e) {
      console.log("Network Changed: ", e)
      updatePrinter()
    }
    // TODO
  }
  //updatePrinterInfo()
  var deleteJob = async function(id, token) {
    return fetch(currentPrinter.ip + '/delete-job', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        'id': id,
        'token': token
      })
    })
  }
  var createJob = async function() {
    return await fetch('/_api/job-token').then(res => res.json())
  }
  var requestJobToken = async function(code) {
    return fetch('/_api/job-token?code='+code).then(res => res.json())
  }
  var getPrice = async function(pageCount, colored) {
    console.log(`/_api/calculate-price?config={"page-count":${pageCount},"colored":${colored}}&printer_id=${currentPrinter.id}`)
    return fetch(`/_api/calculate-price?config={"page-count":${pageCount},"colored":${colored}}&printer_id=${currentPrinter.id}`).then(async (response)=> {
      return await response.json()})
  }
  
  
  var requestJobInfo = async function(code) {
    return fetch(currentPrinter.ip + '/get-configs').then(res => res.json())
  }
  var updateConfig = async function(id, doubleSided, withColor, copies) {
    return fetch(currentPrinter.ip + '/set-config', 
      {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          'id': id,
          'config': {
            'copies': copies,
            'color': withColor,
            'double-sided': doubleSided 
          }
        })
      }
    ).then(res => res.json())
  }
  var uploadFile = async function(fileObject, token) {
    var fileForm = new FormData()
    fileForm.append("file", fileObject.files[0])
    fileForm.append("token", token)
    return fetch(currentPrinter.ip + '/job',{
      method: 'POST',
      body: fileForm
    }).then(res => res.json())
  }

  
  
  // get the session and update the currentStatus
  var sessionObject = fetch('/_api/session').then(res => res.json()).then(response =>{
    console.log(response)
    // TODO
  })
  */


  const dragAndDropZone = document.getElementById('file-zone')
  const infoBox = document.getElementById('upload-info')
  const file = document.getElementById('file')

  var t;
  function setMessage(message) {
    infoBox.style.opacity = 1;
    infoBox.innerText = message;
  }

  dragAndDropZone.ondragover = dragAndDropZone.ondragenter = function (evt) {
    evt.preventDefault();
    dragAndDropZone.classList.add('file-drop-zone__focused');
    infoBox.style.opacity = 0;
  };
  dragAndDropZone.ondragleave = function (evt) {
    evt.preventDefault();
    dragAndDropZone.classList.remove('file-drop-zone__focused');

    setMessage('☺️ 拖拽文件到这里');
  }
  dragAndDropZone.ondrop = function (evt) {
    evt.preventDefault();
    dragAndDropZone.classList.remove('file-drop-zone__focused');
    console.log(evt.dataTransfer.files[0]);
    t = evt.dataTransfer.files[0];
    if (evt.dataTransfer.files[0].type !== 'application/pdf') {
      setMessage('💀 请上传 PDF 文件');
      return;
    }
    // TODO: real upload and request part
    file.files = evt.dataTransfer.files
    
    setMessage('🤗 好嘞，正在上传' + evt.dataTransfer.files[0].name);
    element.onchange();
  };
  file.addEventListener('change', function (e) {
    console.log('Event change', e)
    t = file.files[0];
    console.log('file: ', t)
    if (t.type !== 'application/pdf') {
      setMessage('💀 请上传 PDF 文件');
      return;
    }
    setMessage('🤗 好嘞，正在上传' + t.name);
    // TODO
  })
</script>
{% endblock script%}