{% extends 'framework.html' %}

{% block title %} ä¸Šä¼ æ–‡ä»¶ | Cloud Print {% endblock title%}

{% block stylesheet%}
<link rel="stylesheet" href="/static/css/index.css" />
{% endblock stylesheet %}

{% block content %}
  <div class="mdc-card printer-card">
    <img class="printer-card__logo" src="https://squoosh.app/logo.af355.svg" />
    <div class="printer-card__content">
      <h5 class="mdc-typography--headline5" style="margin: 0 10px 0 0;"id="printer-info">ICCæ¥¼å››å±‚ä¸œä¾§</h5>
      <div class="printer-card__status">
        <span clas="mdc-typography--body1">çŠ¶æ€ï¼š </span>
        <span class="printer-status printer-status__unavaliable" id="printer-status-icon">â¬¤</span>
        <span clas="mdc-typography--body1" id="printer-status">ä¸å¯ç”¨</span>
      </div>
      <span clas="mdc-typography--body1" id="printer-description">æè¿°ï¼šè¿™æ˜¯ä¸€å°æ‰“å°æœº</span>
    </div>
  </div>
  <div class="file-list-container" id="job-list">
  </div>
  <div class="file-drop-zone" id="file-zone">
    <span class="mdc-typography--headline5 drag-info" id="upload-info">â˜ºï¸ æ‹–æ‹½æ‚¨è¦æ‰“å°çš„æ–‡ä»¶åˆ°è¿™é‡Œ</span>
    <p class="drag-info">æˆ–è€…</p>
    <div>
      <button onclick="javascript: document.getElementById('file').click();" class="mdc-button mdc-button--raised">é€‰æ‹©ä¸€ä¸ªæ–‡ä»¶</button>
    </div>
  </div>
  <div class="mdc-dialog"
    id="go-print-dialog"
    role="printdialog"
    aria-modal="false"
    aria-labelledby="my-dialog-title"
    aria-describedby="my-dialog-content">
    <div class="mdc-dialog__container">
      <div class="mdc-dialog__surface">
        <!-- Title cannot contain leading whitespace due to mdc-typography-baseline-top() -->
        <h2 class="mdc-dialog__title" id="my-dialog-title"><!--
      -->æ‚¨çš„æ‰“å°ç <!--
    --></h2>
        <div class="mdc-dialog__content"> 
          <h3 class="mdc-typography--headline3"id="print-code"></h3>
          <span class="mdc-typography--body1">èµ°åˆ°æ‰“å°æœºå‰ï¼Œè¾“å…¥ä¸Šæ–¹çš„å››ä¸ªæ•°å­— å³å¯ç«‹åˆ»æ‰“å°æ‚¨çš„æ–‡ä»¶</span>
          <p></p>
          <span class="mdc-typography--body1">æ‚¨æœªæ‰“å°çš„æ–‡ä»¶å°†è¢«ä¿å­˜24å°æ—¶</span>
        </div>
        <footer class="mdc-dialog__actions">
          <button type="button" class="mdc-button mdc-dialog__button" data-mdc-dialog-action="close">
            <span class="mdc-button__label">å…³é—­</span>
          </button>
        </footer>
      </div>
    </div>
    <div class="mdc-dialog__scrim"></div>
  </div>
  
  <div class="mdc-dialog"
    id="alert-dialog"
    role="alertdialog"
    aria-modal="false"
    aria-labelledby="my-dialog-title"
    aria-describedby="my-dialog-content">
    <div class="mdc-dialog__container">
      <div class="mdc-dialog__surface">
        <!-- Title cannot contain leading whitespace due to mdc-typography-baseline-top() -->
        <h2 class="mdc-dialog__title" id="my-dialog-title"><!--
      -->æç¤º<!--
    --></h2>
        <div class="mdc-dialog__content"> 
          <h3 class="mdc-typography--headline3"id="alert-message"></h3>
        </div>
        <footer class="mdc-dialog__actions">
          <button type="button" class="mdc-button mdc-dialog__button" data-mdc-dialog-action="close">
            <span class="mdc-button__label">å…³é—­</span>
          </button>
        </footer>
      </div>
    </div>
    <div class="mdc-dialog__scrim"></div>
  </div>

<input id="file" type="file" accept="application/pdf" style="display: none;" />
{% endblock content %}
{% block script %}
<script src="https://cdn.jsdelivr.net/npm/@material/dialog@2.3.0/dist/mdc.dialog.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@material/switch@2.3.0/dist/mdc.switch.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@material/auto-init@2.3.0/dist/mdc.autoInit.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@material/textfield@2.3.0/dist/mdc.textfield.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@material/dialog@2.3.0/dist/mdc.dialog.min.js"></script>
<script id="jobTemplate" language="x/template">
  <div class="mdc-card job-card" id="job-::code::">
    <div class="job-card--content">
    <span class="mdc-typography--headline5 job-title">::jobTitle::</span>
    <span class="mdc-typography--body">å…± <span id="page-number-::code::">::pageNumber::</span> é¡µï¼›
                                          <span id="price-::code::">::price::</span> å…ƒ
    </span>
    </div>
    <div class="job-card--options">
      <div class="switch">
        <div class="mdc-switch" id="ds-switch-::code::" data-mdc-auto-init="MDCSwitch">
          <div class="mdc-switch__track"></div>
          <div class="mdc-switch__thumb-underlay">
            <div class="mdc-switch__thumb">
              <input type="checkbox" id="double-sided-switch-::code::" class="mdc-switch__native-control" role="switch" />
            </div>
          </div>
        </div>
        <label for="double-sided-switch">åŒé¢æ‰“å°</label>
      </div>
      <div class="switch">
        <div class="mdc-switch" id="c-switch-::code::" data-mdc-auto-init="MDCSwitch">
          <div class="mdc-switch__track"></div>
          <div class="mdc-switch__thumb-underlay">
            <div class="mdc-switch__thumb">
              <input type="checkbox" id="color-swtich-::code::" class="mdc-switch__native-control" role="switch" />
            </div>
          </div>
        </div>
        <label for="color-switch">å½©è‰²æ‰“å°</label>
      </div>

      <div class="mdc-text-field mdc-text-field--outlined copies" id="c-::code::" data-mdc-auto-init="MDCTextField">
        <input id="copies-::code::" type="number" min="1" max="10" step="1" class="mdc-text-field__input" value="1" required />
        <div class="mdc-notched-outline mdc-notched-outline--upgraded">
          <div class="mdc-notched-outline__leading"></div>
          <div class="mdc-notched-outline__notch" style="">
            <label for="copies-::code::" class="mdc-floating-label mdc-floating-label--float-above" style="">æ‰“å°ä»½æ•°</label>
          </div>
          <div class="mdc-notched-outline__trailing"></div>
        </div>
      </div>
    </div>

    <div class="job-card--actions">
      <button id="go-print-::code::" class="mdc-button mdc-button--raised">å»æ‰“å°</button>
      <button id="delete-job-::code::" class="mdc-button mdc-button--outlined">åˆ é™¤ä»»åŠ¡</button>
    </div>
    <input type="file" style="display: none;" id="file-body"></input>
  </div>
</script>
<script type="text/javascript">
  var $ = function (value) { return document.querySelector(value) }

  const MAX_JOB_NUMBER = 1;
  var jobTemplate = $('#jobTemplate').innerHTML
  mdc.autoInit.mdcAutoInit.register('MDCTextField', mdc.textfield.MDCTextField)
  mdc.autoInit.mdcAutoInit.register('MDCTextFieldHelperText', mdc.textfield.MDCTextFieldHelperText)
  mdc.autoInit.mdcAutoInit.register('MDCSwitch', mdc.switch.MDCSwitch)
  // [element control]
  const printerCard = {
    _setPrinterAvaliability(isAvaliable) {
      $('#printer-status-icon').classList.remove(isAvaliable ? 'printer-status__unavaliable': 'printer-status__avaliable')
      $('#printer-status-icon').classList.add(isAvaliable ? 'printer-status__avaliable': 'printer-status__unavaliable')
      $('#printer-status').innerText = isAvaliable ? 'å°±ç»ª' : 'ä¸å¯ç”¨'
    },
    setPrinterInfo (name, isAvaliable, description) {
      $('#printer-info').innerText = name
      this._setPrinterAvaliability(isAvaliable)
      $('#printer-description').innerText = description
    }
  }
  printerCard.setPrinterInfo('A printer', true, 'This is a printer; I like printers; Printers are good for our health.')
  
  var dialogBox = new mdc.dialog.MDCDialog($('#go-print-dialog'))
  function popDialog(jobCode) {
    $('#print-code').innerText = jobCode
    dialogBox.open()
  }

  var alertBox = new mdc.dialog.MDCDialog($('#alert-dialog'))
  function popAlert(message) {
    $('#alert-message').innerText = message
    alertBox.open()
  }

  var hideUploadField = function() {
    console.log('hideJob')
    $('#file-zone').classList.add('invisible')
  }
  var showUploadField = function() {
    console.log('showJob')
    $('#file-zone').classList.remove('invisible')
  }
  var addJob = function (fileName, code, id, config, pageCount) {
    var price = 0
    ;(async ()=>{
      price = await getPrice(pageCount, config.colored)
    
      $('#job-list').innerHTML += jobTemplate
        .replace(/::jobTitle::/g, fileName)
        .replace(/::pageNumber::/g, pageCount)
        .replace(/::price::/g, price)
        .replace(/::code::/g, code)
      mdc.autoInit.mdcAutoInit()
      var withCode = function(value) { return value + '-' + code}
      // about info
      var pageNumber = $(withCode('#page-number'))
      var price = $(withCode('#price'))
      // about config
      var doubleSidedSwitch = $(withCode('#ds-switch')).MDCSwitch
      var colorSwitch = $(withCode('#c-switch')).MDCSwitch
      var copiesTextfield = $(withCode('#c')).MDCTextField
      // about action
      var printButton = $(withCode('#go-print'))
      var deleteJobButton = $(withCode('#delete-job'))

      printButton.onclick = function() {
        popDialog(code)
      }

      deleteJobButton.onclick = function () {
        ;( async() =>{
          await deleteJob(await requestJobToken(code))
          $(withCode('job')).remove()
        })()
      }

      doubleSidedSwitch.onchange = colorSwitch.onchange = copiesTextfield.onchange = function() {
        ;( async() =>{
          await updateConfig(id, doubleSidedSwitch.checked, colorSwitch.checked, copiesTextfield.value)
        })()
        if (copiesTextfield.value == null || copiesTextfield.value == '') copiesTextfield.value=1
        console.log('Value changed')
      }
    })()
  }
  //end element control

  var currentStatus = {
    "codes": [],
    "kredit": 0,
    "inDebt": false
  }
  var currentPrinter = {
    "id": 255,
    "ip": '0.0.0.0',
    "avaliable": true,
    "name": 'A printer',
    "description": 'This is a printer; I like printers; Printers are good for our health.',
    base: new URL('http://0.0.0.0/'),
  };
  var constructEndpointURL = function (route) { return new URL(route, currentPrinter.base) }

  var updatePrinter = async function() {
    // TODO: add DNS stuff
    var printerConfigs = await fetch('/_api/printer-ips').then(res => res.json())
    console.log("Get printer config: ", printerConfigs)
    for(var id in printerConfigs) {
      var ip = printerConfigs[id]
      const base = new URL(`http://${ip.replace(/\./g, '-')}.ip.kcps.monster`)
      console.log("Trying printer id: ", id)
    
      try {
        const res = await fetch(new URL('/status', base)).then(res => res.json())
        if (res.status !== 0) throw res
        const config = res.response
        currentPrinter = {
          id,
          ip,
          avaliable: true,
          name: config.name,
          description: config.message,
          base,
        }
        break
      } catch (e) {
        console.log('Failed.', e)
      }
    }
    
    if (!currentPrinter) {
      // TODO:
      console.log("No printers Avaliable")
    }
  }

  var updatePrinterInfo = async function() {
    try {
      var res = await fetch(constructEndpointURL('/status')).then(res => res.json())
      if (res.status !== 0) throw res
      const config = res.response
      currentPrinter.description = newConfig.message
    } catch(e) {
      console.log("Network Changed: ", e)
      updatePrinter()
    }
    printerCard.setPrinterInfo(currentPrinter.name, currentPrinter.avaliable, currentPrinter.description)
  }

  var deleteJob = async function(code) {
    const token = await requestJobToken(code)
    return fetch(constructEndpointURL('/delete-job'), {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        token,
      })
    })
  }

  var createJob = async function() {
    return await fetch('/_api/job-token').then(res => res.json())
  }
  var requestJobToken = async function(code) {
    return await fetch('/_api/job-token?code='+code).then(res => res.json())
  }
  var getPrice = async function(pageCount, colored) {
    console.log(`/_api/calculate-price?config={"page-count":${pageCount},"colored":${colored}}&printer_id=${currentPrinter.id}`)
    return await fetch(`/_api/calculate-price?config={"page-count":${pageCount},"colored":${colored}}&printer_id=${currentPrinter.id}`).then(res=>res.json()).then(response=> {
      if(response.status === 0) return response.result / 100
      console.log('Error: ', response)
    })
  }
  
  var requestAllInfo = async function(codes, timestamp, sign) {
    return await fetch(constructEndpointURL('/get-configs'), {
      method: 'post',
      body: JSON.stringify({
        codes,
        timestamp,
        sign
      }),
      headers: {
        'Content-Type': 'application/json',
      },
    }).then(res => res.json())
  }

  var updateConfig = async function(id, doubleSided, withColor, copies) {
    return await fetch(constructEndpointURL('/set-config'), 
      {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          'id': id,
          'config': {
            'copies': copies,
            'color': withColor,
            'double-sided': doubleSided 
          }
        })
      }
    ).then(res => res.json())
  }
  /* untested */
  var uploadFile = async function(fileObject) {
    var fileForm = new FormData()
    fileForm.append("file", fileObject)
    var token = await createJob()
    if(typeof token['status'] !== 'undefined' && token.status === 1){
      popAlert('æ‚¨ä¸Šä¼ çš„æ–‡ä»¶æ•°é‡å·²ç»è¾¾åˆ°æœ€å¤§å…è®¸å€¼')
    }
    fileForm.append("token", JSON.stringify(await createJob()))
    return await fetch(constructEndpointURL('/job'),{
      method: 'POST',
      body: fileForm
    }).then(res => res.json()).then(function(response) {
      if (response.status === 0) {
        response = response.response
        addJob(fileObject.name, response.code, response.id, response.config, response["page-count"])
      }
    })
  }

  
  
  // get the session and update the currentStatus
  var getSession = async function() {
    return await fetch('/_api/session').then(res => res.json())
  }

  var updateSession = async function() {
    var sessionObject = await getSession()
    // get job info
    var jobInfo = await requestAllInfo(sessionObject.codes, sessionObject.timestamp, sessionObject.sign)
    console.log('Got job info: ', jobInfo)
    if(sessionObject.debt > 0) currentStatus.inDebt = true
    currentStatus.kredit = sessionObject.kredit
    currentStatus.codes = sessionObject.codes
  }

  const dragAndDropZone = document.getElementById('file-zone')
  const infoBox = document.getElementById('upload-info')
  const file = document.getElementById('file')

  var t;
  function setMessage(message) {
    infoBox.style.opacity = 1;
    infoBox.innerText = message;
  }

  dragAndDropZone.ondragover = dragAndDropZone.ondragenter = function (evt) {
    evt.preventDefault();
    dragAndDropZone.classList.add('file-drop-zone__focused');
    infoBox.style.opacity = 0;
  };
  dragAndDropZone.ondragleave = function (evt) {
    evt.preventDefault();
    dragAndDropZone.classList.remove('file-drop-zone__focused');

    setMessage('â˜ºï¸ æ‹–æ‹½æ–‡ä»¶åˆ°è¿™é‡Œ');
  }
  dragAndDropZone.ondrop = function (evt) {
    evt.preventDefault();
    dragAndDropZone.classList.remove('file-drop-zone__focused');
    console.log(evt.dataTransfer.files[0]);
    t = evt.dataTransfer.files[0];
    if (evt.dataTransfer.files[0].type !== 'application/pdf') {
      setMessage('ğŸ’€ è¯·ä¸Šä¼  PDF æ–‡ä»¶');
      return;
    }
    // TODO: real upload and request part
    file.files = evt.dataTransfer.files
    
    setMessage('ğŸ¤— å¥½å˜ï¼Œæ­£åœ¨ä¸Šä¼ ' + evt.dataTransfer.files[0].name);
    element.onchange();
  };
  file.addEventListener('change', function (e) {
    console.log('Event change', e)
    t = file.files[0];
    console.log('file: ', t)
    if (t.type !== 'application/pdf') {
      setMessage('ğŸ’€ è¯·ä¸Šä¼  PDF æ–‡ä»¶');
      return;
    }
    setMessage('ğŸ¤— å¥½å˜ï¼Œæ­£åœ¨ä¸Šä¼ ' + t.name);
    // TODO
    uploadFile(t)
  })
  ;(async()=>{
    await updatePrinter()
    await updatePrinterInfo()
    await updateSession()
  })()
</script>
{% endblock script%}